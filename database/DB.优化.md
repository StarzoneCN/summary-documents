# <div style="text-align:center;color:#FF9900">数据库优化</div>


### 字段定义
1. **字段宽度尽可能的小**
   * *表越小，查询越快*；
   * char(M)类型的数据列里，每个值都占用M个字节，如果某个长度小于M，MySQL就会在它的右边用空格字符补足．（在检索操作中那些填补出来的空格字符将被去掉）；
   * 在varchar(M)类型的数据列里，每个值只占用刚好够用的字节再加上一个用来记录其长度的字节（即总长度为L+1字节）；
   * 对于MyISAM表，尽量使用Char，对于那些经常需要修改而容易形成碎片的myisam和isam数据表就更是如此，它的缺点就是占用磁盘空间；
   * 对于InnoDB表，因为它的数据行内部存储格式对固定长度的数据行和可变长度的数据行不加区分（所有数据行共用一个表头部分，这个标头部分存放着指向各有关数据列的指针），所以使用char类型不见得会比使用varchar类型好。事实上，因为char类型通常要比varchar类型占用更多的空间，所以从减少空间占用量和减少磁盘i/o的角度，使用varchar类型反而更有利.
   * varchar他既然可以自动适应存储空间，那我varchar(8)和varchar(255)存储应该都是一样的，那每次表设计的时候往大的方向去好了，免得以后不够用麻烦。这个思路对吗？
     > 答案是否定的。mysql会把表信息放到内存中（查询第一次后，就缓存住了，linux下很明显，但windows下似乎没有，不知道为啥），这时内存的申请是按照固定长度来的，如果varchar很大就会有问题。所以还是应该按需索取。

   * 对于某些文本字段，例如“省份”或者“性别”，我们可以将它们定义为ENUM类型。因为在MySQL中，ENUM类型被当作数值型数据来处理，而数值型数据被处理起来的速度要比文本类型快得多;
     > ENUM: 紧凑型数据存储，MySQL ENUM使用数字索引(1，2，3，…)来表示字符串值;

   参考：[mysql中char与varchar的区别分析][]、[用char还是varchar？答案和原理都告诉你][]


### 查询
1. **用JOIN代替字查询**
   MySQL不需要在内存中创建临时表来保存子查询的结果；

2. **索引**
   * 索引是提高数据库性能的常用方法，它可以令数据库服务器以比没有索引快得多的速度检索特定的行，尤其是在查询语句当中包含有MAX(),MIN()和ORDERBY这些命令的时候，性能提高更为明显；
   * 索引应建立在那些将用于JOIN,WHERE判断和ORDERBY排序的字段上；
   * 不要对数据库中某个含有大量重复的值的字段建立索引；
   * 避免在查询中让MySQL进行自动类型转换，因为转换过程也会使索引变得不起作用；

3. **恰当的SQL**
   * 最好是在相同类型的字段间进行比较的操作；
   * 在建有索引的字段上尽量不要使用函数进行操作；
     可能使索引失效
   * LIKE优化：
     ```SQL
      col like "MySQL%";
      -- 优化为
      col >="MySQL" and col < "MySQM";
     ```
   * 减少函数使用
     ```SQL
      select * from users where YEAR(adddate)<2007;
      -- 优化后
      select * from users where adddate<'2007-01-01';
     ```
    * `NOT IN`可以`NOT EXISTS`代替;`id<>3`则可使用`id>3 or id<3`来代替
      NOT IN和<>操作都不会使用索引将进行全表扫描;
    * 应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，**最好不要给数据库留NULL，尽可能的使用 NOT NULL填充数据库**
    * `!=`没有使用索引，以下示例（关于`!='Tom'`的改写）待验证：
       ```SQL
       SELECT * FROM `user` a WHERE a.`name` > 'Tom' UNION SELECT * FROM `user` a WHERE a.`name` < 'Tom';
       ```
    * 经测试（mariadb 10.4.7），`in`是走索引的；
    * `OR`不走索引（mariadb 10.4.7 测试结果）；

### 索引
参考：[mysql联合索引详解][]
1. **复合索引**
   > 如果我们创建了(area, age, salary)的复合索引，那么其实相当于创建了(area,age,salary)、(area,age)、(area)三个索引，这被称为最佳左前缀特性。因此我们在创建复合索引时应该将最常用作限制条件的列放在最左边，依次递减;

   > 只要列中包含有NULL值都将不会被包含在索引中，复合索引中只要有一列含有NULL值，那么这一列对于此复合索引就是无效的。所以我们在数据库设计时不要让字段的默认值为NULL。

2. **前缀索引**-短索引
   > 如果有一个CHAR(255)的 列，如果在前10个或20个字符内，多数值是惟一的，那么就不要对整个列进行索引。短索引不仅可以提高查询速度而且可以节省磁盘空间和I/O操作;

3. **全文索引**
   > 在数据量较大时候，现将数据放入一个没有全局索引的表中，然后再用CREATE index创建fulltext索引，要比先为一张表建立fulltext然后再将数据写入的速度快很多;

4. **空间索引**
   > 空间索引是对空间数据类型的字段建立的索引，MYSQL中的空间数据类型有4种，分别是GEOMETRY（地图测绘）、POINT、LINESTRING、POLYGON（多边形）。
   > MYSQL使用SPATIAL关键字进行扩展，使得能够用于创建正规索引类型的语法创建空间索引。创建空间索引的列，必须将其声明为NOT NULL，空间索引只能在存储引擎为MYISAM的表中创建;
   > 全文索引检索，要注意，全文索引的优先级很高，若全文索引和普通索引同时存在时，mysql不管代价，优先选择使用全文索引;

### 临时表/表变量
> 对于较小的临时计算用数据集推荐使用表变量;
> 使用表变量需要考虑内存压力；
> 对于大的数据集推荐使用临时表同时创建索引;
> 同时存在名称相同的临时表，临时表操作的优先级更高;
> 同名临时表不能共存;






[mysql中char与varchar的区别分析]:https://www.jb51.net/article/23575.htm
[用char还是varchar？答案和原理都告诉你]:https://www.jianshu.com/p/a1aa86e17bf7
[mysql联合索引详解]:https://cloud.tencent.com/developer/article/1030117 "关键词：索引的最左匹配特性、范围查询中应用"
[Mysql前缀索引长度确定方法]:https://www.jianshu.com/p/89388af13ef3
